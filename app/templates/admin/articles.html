{% extends "admin/base.html" %}

{% block title %}文章管理 - ShopSphere{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">文章管理</h3>
        <div class="flex items-center space-x-4">
            <form method="get" action="/admin/articles" class="flex items-center space-x-2">
                <label for="status" class="text-sm text-gray-600">状态</label>
                <select id="status" name="status" onchange="this.form.submit()"
                    class="block w-44 pl-3 pr-8 py-2 text-sm bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:bg-white focus:ring-2 focus:ring-primary focus:border-primary cursor-pointer">
                    <option value="" {% if not current_status %}selected{% endif %}>全部</option>
                    {% for s in all_statuses %}
                    <option value="{{ s }}" {% if current_status==s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </form>
            <button id="bulkDeleteBtn" disabled
                class="px-3 py-1.5 bg-red-500 text-white rounded shadow-sm opacity-50 cursor-not-allowed">批量删除</button>
        </div>
    </div>
    <div class="border-t border-gray-200">
        <div class="bg-white">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col">
                    <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                        <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                            <div class="overflow-hidden border-b border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3"><input type="checkbox" id="checkAll" class="h-4 w-4">
                                            </th>
                                            {% set dir_toggle = 'asc' if sort!='id' or dir=='desc' else 'desc' %}
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                <a href="?page=1{% if current_status %}&status={{current_status}}{% endif %}&sort=id&dir={{ dir_toggle }}"
                                                    class="flex items-center hover:text-primary">
                                                    ID
                                                    {% if sort=='id' %}
                                                    {% if dir=='asc' %}
                                                    <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 3l3 4H7l3-4z" />
                                                    </svg>
                                                    {% else %}
                                                    <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 17l-3-4h6l-3 4z" />
                                                    </svg>
                                                    {% endif %}
                                                    {% endif %}
                                                </a>
                                            </th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                标题</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                内容</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                关联商品</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                标签</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative whitespace-nowrap">
                                                <div class="flex items-center">
                                                    状态
                                                    <svg class="ml-1 h-4 w-4 text-gray-400"
                                                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                        fill="currentColor">
                                                        <path fill-rule="evenodd"
                                                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                                            clip-rule="evenodd" />
                                                    </svg>
                                                    <div
                                                        class="absolute hidden group-hover:block bg-black bg-opacity-75 text-white text-xs normal-case rounded-lg p-2 -left-24 top-8 w-64 z-10 whitespace-normal leading-5">
                                                        draft: 表示AI生成草稿<br>
                                                        pending_review: 表示看过了，但还需要再修改<br>
                                                        rejected: 表示审核不通过，脚本会重新生成新的文章<br>
                                                        pending_publish: 表示审核通过，待发布
                                                        <div
                                                            class="absolute -top-1 left-32 w-3 h-3 bg-black bg-opacity-75 transform rotate-45">
                                                        </div>
                                                    </div>
                                                </div>
                                            </th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                关联视频</th>
                                            {% set dir_pre = 'asc' if sort!='pre_publish_time' or dir=='desc' else
                                            'desc' %}
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                                <a href="?page=1{% if current_status %}&status={{current_status}}{% endif %}&sort=pre_publish_time&dir={{ dir_pre }}"
                                                    class="flex items-center hover:text-primary">预发布时间
                                                    {% if sort=='pre_publish_time' %}{% if dir=='asc' %}<svg
                                                        class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 3l3 4H7l3-4z" />
                                                    </svg>{% else %}<svg class="w-3 h-3 ml-1" fill="currentColor"
                                                        viewBox="0 0 20 20">
                                                        <path d="M10 17l-3-4h6l-3 4z" />
                                                    </svg>{% endif %}{% endif %}
                                                </a> (UTC+08)
                                            </th>
                                            {% set dir_pub = 'asc' if sort!='publish_time' or dir=='desc' else 'desc' %}
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                                <a href="?page=1{% if current_status %}&status={{current_status}}{% endif %}&sort=publish_time&dir={{ dir_pub }}"
                                                    class="flex items-center hover:text-primary">发布时间
                                                    {% if sort=='publish_time' %}{% if dir=='asc' %}<svg
                                                        class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 3l3 4H7l3-4z" />
                                                    </svg>{% else %}<svg class="w-3 h-3 ml-1" fill="currentColor"
                                                        viewBox="0 0 20 20">
                                                        <path d="M10 17l-3-4h6l-3 4z" />
                                                    </svg>{% endif %}{% endif %}
                                                </a> (UTC+08)
                                            </th>
                                            {% set dir_create = 'asc' if sort!='create_at' or dir=='desc' else 'desc' %}
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                                <a href="?page=1{% if current_status %}&status={{current_status}}{% endif %}&sort=create_at&dir={{ dir_create }}"
                                                    class="flex items-center hover:text-primary">创建时间
                                                    {% if sort=='create_at' %}{% if dir=='asc' %}<svg
                                                        class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 3l3 4H7l3-4z" />
                                                    </svg>{% else %}<svg class="w-3 h-3 ml-1" fill="currentColor"
                                                        viewBox="0 0 20 20">
                                                        <path d="M10 17l-3-4h6l-3 4z" />
                                                    </svg>{% endif %}{% endif %}
                                                </a> (UTC+08)
                                            </th>
                                            <th
                                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for art in articles %}
                                        <tr>
                                            <td class="px-4 py-4 whitespace-nowrap"><input type="checkbox"
                                                    class="row-check h-4 w-4" data-id="{{ art.id }}"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ art.id }}
                                            </td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate">
                                                {{ art.title }}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500 max-w-md truncate">
                                                <span title="点击预览" class="cursor-pointer" onclick="openPreview(this)"
                                                    data-content="{{ art.content|replace('\n','&#10;') }}">
                                                    {{ art.content[:60] + '...' if art.content and art.content|length >
                                                    60 else art.content or '-' }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% set prod = product_map.get(art.item_id) %}
                                                {% if prod %}
                                                <div class="flex items-center">
                                                    {% set thumb = (prod.images[0].link if prod.images and
                                                    prod.images[0].get('link') else None) %}
                                                    <div class="flex-shrink-0 h-8 w-8">
                                                        <img class="h-8 w-8 rounded-md object-cover"
                                                            src="{{ (thumb ~ '?imageView2/2/w/80/format/webp/q/75') if thumb else '/static/images/placeholder.png' }}"
                                                            alt="{{ prod.item_name }}">
                                                    </div>
                                                    <div class="ml-2 text-sm text-gray-900">
                                                        <div class="truncate w-40 font-medium">{{ prod.item_name }}
                                                        </div>
                                                        <div class="flex items-center text-xs text-gray-500 space-x-1">
                                                            <span>ID:</span>
                                                            <div class="group relative inline-flex items-center cursor-pointer select-none rounded bg-gray-50 hover:bg-gray-100 px-1.5 py-0.5 font-mono text-gray-700 transition-all copy-wrap"
                                                                onclick="copyToClipboard('{{ prod.item_id }}', event)">
                                                                <span>{{ prod.item_id }}</span>
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                    class="copy-icon h-4 w-4 ml-1 text-gray-400 opacity-0 group-hover:opacity-100 transform group-hover:scale-100 scale-90 transition"
                                                                    viewBox="0 0 20 20" fill="currentColor">
                                                                    <path
                                                                        d="M8 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V6l-6-4H8z" />
                                                                </svg>
                                                                <span
                                                                    class="copy-tick absolute right-0 top-1/2 -translate-y-1/2 h-4 w-4 flex items-center justify-center text-green-600 text-sm opacity-0">✅</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <span class="text-xs text-gray-400">无</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs">
                                                {% if art.tags %}
                                                {% set tag_list = art.tags.split(',') %}
                                                <div class="flex flex-nowrap items-center gap-1 overflow-hidden cursor-pointer"
                                                    title="点击预览" onclick="openPreview(this)"
                                                    data-content="{{ art.tags }}" data-title="标签预览">
                                                    {% for tag in tag_list[:3] %}
                                                    <span
                                                        class="inline-flex items-center bg-blue-100 text-primary rounded-full px-2 py-0.5 text-xs">{{
                                                        tag }}</span>
                                                    {% endfor %}
                                                    {% if tag_list|length > 3 %}
                                                    <span class="text-xs text-gray-500">+{{ tag_list|length - 3
                                                        }}</span>
                                                    {% endif %}
                                                </div>
                                                {% else %}-{% endif %}
                                            </td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                                    {% if art.status == ArticleStatus.PUBLISHED.value %}bg-green-100 text-green-800
                                                    {% elif art.status == ArticleStatus.PENDING_PUBLISH.value or art.status == ArticleStatus.PENDING_REVIEW.value %}bg-yellow-100 text-yellow-800
                                                    {% elif art.status == ArticleStatus.REJECTED.value %}bg-red-100 text-red-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ art.status.value if art.status is mapping else art.status.value
                                                    if art.status.__class__.__name__=='ArticleStatus' else art.status }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% if art.id in video_map %}
                                                <div class="flex justify-center">
                                                    {% set video_info = video_map[art.id] %}
                                                    {% set video = video_info.video %}
                                                    {% set ratio = video.width / video.height if video.height else 1 %}
                                                    {% set h = 120 / ratio %}
                                                    {% set display_h = h if h <= 120 else 120 %} <div
                                                        style="width:120px;height:{{ display_h }}px"
                                                        class="relative group" data-video-id="{{ video.id }}">
                                                        <img src="{{ video_info.thumb_url }}"
                                                            class="rounded object-contain w-full h-full">
                                                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 cursor-pointer"
                                                            onclick="openPlayer('{{ video.id }}')">
                                                            <div
                                                                class="w-8 h-8 rounded-full bg-black bg-opacity-50 flex items-center justify-center transform scale-0 group-hover:scale-100 transition-transform duration-300">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                    class="h-5 w-5 text-white" fill="none"
                                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                </svg>
                                                            </div>
                                                        </div>
                                                </div>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ art.pre_publish_time|datetimeformat if art.pre_publish_time else '-'
                                }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ art.publish_time|datetimeformat if art.publish_time else '-' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ art.create_at|datetimeformat }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="/admin/articles/{{ art.id }}/edit"
                                    class="inline-flex items-center px-2.5 py-0.5 mr-2 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 text-xs font-medium transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path
                                            d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                        <path fill-rule="evenodd"
                                            d="M5 13.5V16h2.5l9.586-9.586-2.5-2.5L5 13.5zM4 17a1 1 0 001 1h3.586a1 1 0 00.707-.293l10-10a1 1 0 000-1.414l-3.586-3.586a1 1 0 00-1.414 0l-10 10A1 1 0 004 14.414V17z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    编辑
                                </a>
                                <button onclick="deleteArticle('{{ art.id }}')"
                                    class="inline-flex items-center px-2.5 py-0.5 rounded bg-red-50 text-red-600 hover:bg-red-100 text-xs font-medium transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M9 2a1 1 0 011 1v1h5a1 1 0 110 2H5a1 1 0 110-2h5V3a1 1 0 011-1zM5 7a1 1 0 011 1v7a1 1 0 102 0V8a1 1 0 112 0v7a1 1 0 102 0V8a1 1 0 112 0v7a1 1 0 102 0V8a1 1 0 011-1h-1V6H6v1H5z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    删除
                                </button>
                            </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                            </table>
                        </div>
                        <!-- 分页导航已移至底部 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- 分页导航（固定底部） -->
<div class="sticky bottom-0 left-0 w-full bg-white py-3 flex justify-center space-x-4 border-t shadow-inner z-30">
    {% if has_prev %}
    <a href="?page={{ page-1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if dir %}&dir={{ dir }}{% endif %}"
        class="w-20 text-center px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">上一页</a>
    {% else %}
    <span class="w-20 text-center px-3 py-1 rounded bg-gray-50 text-gray-400 text-sm cursor-not-allowed">上一页</span>
    {% endif %}

    <span class="px-3 py-1 text-sm text-gray-600">第 {{ page }} / {{ total_pages }} 页</span>

    {% if has_next %}
    <a href="?page={{ page+1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if dir %}&dir={{ dir }}{% endif %}"
        class="w-20 text-center px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">下一页</a>
    {% else %}
    <span class="w-20 text-center px-3 py-1 rounded bg-gray-50 text-gray-400 text-sm cursor-not-allowed">下一页</span>
    {% endif %}
</div>

<script>
    function deleteArticle(articleId) {
        Swal.fire({
            title: '确认删除？',
            text: "删除后将无法恢复！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '确认删除',
            cancelButtonText: '取消',
            background: '#fff',
            customClass: {
                confirmButton: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 mr-2',
                cancelButton: 'px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // 发送删除请求
                fetch('/admin/articles/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify([parseInt(articleId)])
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire({
                                title: '删除成功！',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                // 刷新页面
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: '删除失败',
                                text: '发生未知错误',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: '操作失败',
                            text: '请求过程中发生错误',
                            icon: 'error'
                        });
                    });
            }
        });
    }

    function copyToClipboard(text, evt) {
        const btn = evt && evt.currentTarget;

        const flash = () => {
            if (!btn) return;
            btn.classList.add('ring-2', 'ring-green-400');
            const icon = btn.querySelector('.copy-icon');
            const tick = btn.querySelector('.copy-tick');
            if (icon && tick) {
                icon.classList.add('invisible');
                tick.classList.remove('opacity-0');
                setTimeout(() => {
                    btn.classList.remove('ring-2', 'ring-green-400');
                    icon.classList.remove('invisible');
                    tick.classList.add('opacity-0');
                }, 800);
            }
        };

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(flash).catch(() => fallback());
        } else {
            fallback();
        }

        function fallback() {
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                flash();
            } catch (e) {
                console.error(e);
                alert('复制失败');
            }
        }
    }

    const checkAll = document.getElementById('checkAll');
    const rowChecks = document.querySelectorAll('.row-check');
    const bulkBtn = document.getElementById('bulkDeleteBtn');

    function updateBulkBtn() {
        const anyChecked = Array.from(rowChecks).some(ch => ch.checked);
        bulkBtn.disabled = !anyChecked;
        bulkBtn.classList.toggle('opacity-50', !anyChecked);
        bulkBtn.classList.toggle('cursor-not-allowed', !anyChecked);
    }

    checkAll.addEventListener('change', () => {
        rowChecks.forEach(ch => ch.checked = checkAll.checked);
        updateBulkBtn();
    });
    rowChecks.forEach(ch => ch.addEventListener('change', updateBulkBtn));

    bulkBtn.addEventListener('click', () => {
        const ids = Array.from(rowChecks).filter(ch => ch.checked).map(ch => parseInt(ch.dataset.id));
        if (!ids.length) return;
        Swal.fire({
            title: `确认删除选中的 ${ids.length} 篇文章？`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '删除',
            cancelButtonText: '取消',
            confirmButtonColor: '#d33'
        }).then(res => {
            if (res.isConfirmed) {
                fetch('/admin/articles/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(ids)
                }).then(r => r.json()).then(data => {
                    if (data.status === 'success') {
                        Swal.fire('删除成功', `已删除 ${data.count} 篇文章`, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('操作失败', '删除失败', 'error');
                    }
                }).catch(() => Swal.fire('操作失败', '网络错误', 'error'));
            }
        });
    });
</script>

<!-- 预览弹窗 -->
<div id="previewModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-gray-800 opacity-50" onclick="closePreview()"></div>
    <div class="relative bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[80vh] overflow-auto p-6">
        <h3 id="previewTitle" class="text-lg font-medium text-gray-900 mb-4">预览</h3>
        <div id="previewContent" class="whitespace-pre-wrap text-sm text-gray-800"></div>
        <div class="text-right mt-4">
            <button onclick="closePreview()"
                class="bg-primary text-white px-4 py-1 rounded-md hover:bg-blue-700">关闭</button>
        </div>
    </div>
</div>

<script>
    function openPreview(el) {
        const modal = document.getElementById('previewModal');
        document.getElementById('previewTitle').textContent = el.dataset.title || '预览';
        let raw = el.dataset.content || '';
        // 将字符串中的 \n、\r\n 以及 &#10; / &#13; 转成实际换行符，便于预览
        raw = raw.replace(/&#10;|&#13;/g, '\n') // HTML 实体 -> 换行
            .replace(/\\r\\n|\\n|\\r/g, '\n'); // 转义序列 -> 换行
        const contentEl = document.getElementById('previewContent');
        const title = el.dataset.title || '预览';
        if (title.includes('标签')) {
            const chips = raw.split(',').map(t => t.trim()).filter(t => t).map(t => `<span class="inline-flex items-center bg-blue-100 text-primary rounded-full px-2 py-0.5 text-sm mr-1 mb-1">${t}</span>`).join('');
            contentEl.innerHTML = chips || '<span class="text-gray-400 text-sm">无标签</span>';
        } else {
            contentEl.textContent = raw;
        }
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    function closePreview() {
        const modal = document.getElementById('previewModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
</script>

<!-- 视频播放器模态框 -->
<dialog id="playerModal" class="w-full h-full bg-transparent p-0 m-0">
    <div class="fixed inset-0 bg-black bg-opacity-50"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg shadow-xl w-full max-w-4xl">
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">视频预览</h3>
                    <button onclick="closePlayer()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="playerContainer" class="aspect-video bg-black rounded-lg">
                    <video id="player" class="w-full h-full" controls>
                        您的浏览器不支持 HTML5 视频播放
                    </video>
                </div>
            </div>
        </div>
    </div>
</dialog>

<script>
    // 视频播放相关函数
    function openPlayer(videoId) {
        const modal = document.getElementById('playerModal');
        const player = document.getElementById('player');

        // 获取签名URL
        fetch(`/admin/videos/published/${videoId}/play`)
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    player.src = data.url;
                    modal.showModal();

                    // 自动播放
                    player.play().catch(function (error) {
                        console.log("视频自动播放失败:", error);
                    });
                } else {
                    showToast('获取视频播放地址失败', 'error');
                }
            })
            .catch(error => {
                console.error('获取视频播放地址失败:', error);
                showToast('获取视频播放地址失败', 'error');
            });
    }

    function closePlayer() {
        const modal = document.getElementById('playerModal');
        const player = document.getElementById('player');

        // 确保视频完全停止播放
        try {
            player.pause();  // 暂停播放
            player.currentTime = 0;  // 重置播放位置
            player.src = '';  // 清除视频源
            player.load();  // 强制重新加载，确保完全停止
        } catch (e) {
            console.error('停止视频播放时出错:', e);
        }

        modal.close();
    }

    // 当点击模态框背景时关闭
    document.getElementById('playerModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closePlayer();
        }
    });

    // 添加ESC键关闭支持
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closePlayer();
        }
    });

    // 当模态框关闭时确保视频停止播放
    document.getElementById('playerModal').addEventListener('close', function () {
        const player = document.getElementById('player');
        try {
            player.pause();
            player.currentTime = 0;
            player.src = '';
            player.load();
        } catch (e) {
            console.error('停止视频播放时出错:', e);
        }
    });
</script>
{% endblock content %}

{% block extra_js %}
<script>
    // ... existing delete and copy scripts ...
</script>
{% endblock extra_js %}