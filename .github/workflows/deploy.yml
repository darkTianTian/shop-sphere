name: Deploy to ECS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx
    
    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb
      run: |
        # å¦‚æœtestsç›®å½•å­˜åœ¨ä¸”æœ‰æµ‹è¯•æ–‡ä»¶ï¼Œåˆ™è¿è¡Œæµ‹è¯•
        if [ -d "tests" ] && [ "$(find tests -name '*.py' -not -name '__*' | wc -l)" -gt 0 ]; then
          echo "Running tests..."
          python -m pytest tests/ -v
        else
          echo "No test files found, skipping tests"
          echo "Creating basic test structure for future use"
          mkdir -p tests
          echo "# Add your tests here" > tests/__init__.py
        fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to ECS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          # è®¾ç½®é¡¹ç›®ç›®å½•
          PROJECT_DIR="/opt/shop-sphere"
          REPO_URL="https://github.com/darkTianTian/shop-sphere.git"
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•
          mkdir -p $PROJECT_DIR
          cd $PROJECT_DIR
          
          # å¤‡ä»½å½“å‰æœåŠ¡
          if [ -f docker-compose.prod.yml ]; then
            echo "åœæ­¢å½“å‰æœåŠ¡..."
            docker-compose -f docker-compose.prod.yml down || true
          fi
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          if [ -d ".git" ]; then
            echo "æ›´æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            echo "å…‹éš†ä»£ç ..."
            git clone $REPO_URL .
          fi
          
          # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
          echo "åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
          cat > .env << EOF
          # æ•°æ®åº“é…ç½®
          DATABASE_URL=postgresql://postgres:${{ secrets.DB_PASSWORD }}@db:5432/shop_sphere
          
          # OSSé…ç½®
          OSS_ACCESS_KEY_ID=${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET=${{ secrets.OSS_ACCESS_KEY_SECRET }}
          OSS_BUCKET_NAME=${{ secrets.OSS_BUCKET_NAME }}
          OSS_ENDPOINT=${{ secrets.OSS_ENDPOINT }}
          
          # JWTé…ç½®
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          
          # åº”ç”¨é…ç½®
          ENVIRONMENT=production
          DEBUG=false
          HOST=0.0.0.0
          PORT=8000
          EOF
          
          # åˆ›å»ºç”Ÿäº§ç¯å¢ƒdocker-composeæ–‡ä»¶
          echo "åˆ›å»ºDocker Composeé…ç½®..."
          cat > docker-compose.prod.yml << 'EOF'
          version: '3.8'
          
          services:
            app:
              build:
                context: .
                dockerfile: Dockerfile
              container_name: shop-sphere-app
              ports:
                - "80:8000"
              env_file:
                - .env
              depends_on:
                - db
                - redis
              restart: unless-stopped
              volumes:
                - ./app:/app/app
                - ./static:/app/static
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          
            db:
              image: postgres:13
              container_name: shop-sphere-db
              environment:
                POSTGRES_DB: shop_sphere
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
              volumes:
                - postgres_data:/var/lib/postgresql/data
                - ./init.sql:/docker-entrypoint-initdb.d/init.sql
              ports:
                - "5432:5432"
              restart: unless-stopped
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U postgres"]
                interval: 10s
                timeout: 5s
                retries: 5
          
            redis:
              image: redis:7-alpine
              container_name: shop-sphere-redis
              restart: unless-stopped
              ports:
                - "6379:6379"
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 10s
                timeout: 5s
                retries: 3
          
          volumes:
            postgres_data:
          EOF
          
          # æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
          echo "æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
          docker-compose -f docker-compose.prod.yml build --no-cache
          docker-compose -f docker-compose.prod.yml up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 60
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          docker-compose -f docker-compose.prod.yml ps
          
          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
          for i in {1..10}; do
            if curl -f http://localhost/health 2>/dev/null; then
              echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸï¼"
              break
            else
              echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/10)"
              sleep 10
            fi
          done
          
          # æ˜¾ç¤ºæœåŠ¡æ—¥å¿—
          echo "æœ€è¿‘çš„åº”ç”¨æ—¥å¿—:"
          docker-compose -f docker-compose.prod.yml logs --tail=20 app
          
          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒå’Œå®¹å™¨
          echo "æ¸…ç†èµ„æº..."
          docker system prune -f
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼è®¿é—® http://${{ secrets.ECS_HOST }} æŸ¥çœ‹åº”ç”¨" 