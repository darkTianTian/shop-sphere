name: Deploy to ECS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Basic validation
      run: |
        echo "âœ… Python version check:"
        python --version
        echo "âœ… Requirements installed successfully"
        echo "âœ… Code syntax validation:"
        python -m py_compile app/main.py
        echo "âœ… All validations passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        echo "ğŸ³ Building Docker image..."
        docker build -f deploy/docker/Dockerfile.prod -t shop-sphere:latest .
        echo "âœ… Docker image built successfully"
        
        # ä¿å­˜é•œåƒä¸ºtaræ–‡ä»¶
        docker save shop-sphere:latest | gzip > shop-sphere-image.tar.gz
        echo "âœ… Docker image saved: $(ls -lh shop-sphere-image.tar.gz)"
    
    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        # åˆ›å»ºéƒ¨ç½²åŒ…ï¼ŒåŒ…å«ç°æœ‰çš„é…ç½®æ–‡ä»¶
        mkdir -p deploy-package
        cp deploy/docker/docker-compose.prod.yml deploy-package/
        cp -r deploy/nginx deploy-package/nginx
        cp -r deploy/supervisor deploy-package/supervisor
        cp deploy/scripts/configure-docker-mirrors.sh deploy-package/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy-package/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ECSæœåŠ¡å™¨..."
        
        PROJECT_DIR="/opt/shop-sphere"
        
        # æ£€æµ‹å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ
        if command -v podman &> /dev/null; then
          echo "ğŸ³ ä½¿ç”¨Podmanç¯å¢ƒ"
          CONTAINER_CMD="podman"
          
          # ç›´æ¥ä½¿ç”¨docker-composeé€šè¿‡Podman socketï¼Œé¿å…podman-composeçš„Pythonç‰ˆæœ¬é—®é¢˜
          COMPOSE_CMD="docker-compose"
          
          # ç¡®ä¿Podman socketå¯ç”¨
          echo "ğŸ”Œ é…ç½®Podman socket..."
          sudo systemctl enable --now podman.socket || true
          sleep 3
          
          # è®¾ç½®DOCKER_HOSTç¯å¢ƒå˜é‡
          export DOCKER_HOST="unix:///run/podman/podman.sock"
          
          # éªŒè¯è¿æ¥
          if ! docker-compose version &> /dev/null; then
            echo "âš ï¸ docker-composeæ— æ³•è¿æ¥Podman socketï¼Œå°è¯•åˆ›å»ºé“¾æ¥..."
            sudo mkdir -p /var/run
            sudo ln -sf /run/podman/podman.sock /var/run/docker.sock || true
            unset DOCKER_HOST
          fi
        else
          echo "ğŸ³ ä½¿ç”¨Dockerç¯å¢ƒ"
          CONTAINER_CMD="docker"
          COMPOSE_CMD="docker-compose"
        fi
        
        echo "ğŸ“¦ ä½¿ç”¨å®¹å™¨å‘½ä»¤: $CONTAINER_CMD, ç¼–æ’å‘½ä»¤: $COMPOSE_CMD"
        
        # åœæ­¢å½“å‰æœåŠ¡
        if [ -f $PROJECT_DIR/docker-compose.prod.yml ]; then
          echo "â¸ï¸ åœæ­¢å½“å‰æœåŠ¡..."
          cd $PROJECT_DIR && $COMPOSE_CMD -f docker-compose.prod.yml down || true
        fi
        
        # åˆ›å»ºé¡¹ç›®ç›®å½•
        mkdir -p $PROJECT_DIR
        cd $PROJECT_DIR
        
        # å¤‡ä»½æ—§é•œåƒ
        if $CONTAINER_CMD images shop-sphere:latest -q | grep -q .; then
          echo "ğŸ’¾ å¤‡ä»½æ—§é•œåƒ..."
          $CONTAINER_CMD tag shop-sphere:latest shop-sphere:backup-$(date +%Y%m%d_%H%M%S) || true
        fi
        
        # åŠ è½½æ–°é•œåƒ
        echo "ğŸ“¦ åŠ è½½æ–°Dockeré•œåƒ..."
        $CONTAINER_CMD load < /tmp/shop-sphere-image.tar.gz
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp /tmp/deploy-package/docker-compose.prod.yml .
        cp -r /tmp/deploy-package/nginx .
        cp -r /tmp/deploy-package/supervisor .
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p uploads logs/nginx logs/supervisor mysql/conf.d redis
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        echo "âš™ï¸ åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
        cat > .env << 'ENVEOF'
        # æ•°æ®åº“é…ç½®
        MYSQL_DATABASE=shopsphere
        MYSQL_USER=shopsphere
        MYSQL_PASSWORD=${MYSQL_PASSWORD}
        MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
        
        # OSSé…ç½®
        OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
        OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
        OSS_BUCKET_NAME=${OSS_BUCKET_NAME}
        OSS_ENDPOINT=${OSS_ENDPOINT}
        
        # JWTé…ç½®
        JWT_SECRET_KEY=${JWT_SECRET_KEY}
        
        # åº”ç”¨é…ç½®
        ENVIRONMENT=production
        DEBUG=false
        HOST=0.0.0.0
        PORT=8000
        SERVER_ENVIRONMENT=PRODUCTION
        PYTHONPATH=/app
        ENVEOF
        
        # æ›¿æ¢ç¯å¢ƒå˜é‡å ä½ç¬¦
        sed -i "s/\${MYSQL_PASSWORD}/$MYSQL_PASSWORD/g" .env
        sed -i "s/\${MYSQL_ROOT_PASSWORD}/$MYSQL_ROOT_PASSWORD/g" .env
        sed -i "s/\${OSS_ACCESS_KEY_ID}/$OSS_ACCESS_KEY_ID/g" .env
        sed -i "s/\${OSS_ACCESS_KEY_SECRET}/$OSS_ACCESS_KEY_SECRET/g" .env
        sed -i "s/\${OSS_BUCKET_NAME}/$OSS_BUCKET_NAME/g" .env
        sed -i "s/\${OSS_ENDPOINT}/$OSS_ENDPOINT/g" .env
        sed -i "s/\${JWT_SECRET_KEY}/$JWT_SECRET_KEY/g" .env
        
        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        $COMPOSE_CMD -f docker-compose.prod.yml up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..12}; do
          if $COMPOSE_CMD -f docker-compose.prod.yml exec -T web curl -f http://localhost/health; then
            echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
            break
          else
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/12)"
            sleep 10
          fi
          
          if [ $i -eq 12 ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50
            exit 1
          fi
        done
        
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        $COMPOSE_CMD -f docker-compose.prod.yml ps
        EOF
        
        chmod +x deploy-package/deploy.sh
        
        # æ‰“åŒ…é…ç½®æ–‡ä»¶
        tar -czf deploy-config.tar.gz -C deploy-package .
        echo "âœ… Deployment package created: $(ls -lh deploy-config.tar.gz)"
    
    - name: Transfer Docker image to ECS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "shop-sphere-image.tar.gz"
        target: "/tmp/"
        timeout: 600s
    
    - name: Transfer deployment package to ECS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "deploy-config.tar.gz"
        target: "/tmp/"
    
    - name: Deploy to ECS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        timeout: 600s
        script: |
          # åˆå§‹åŒ–Podmanç¯å¢ƒï¼ˆå¦‚æœä½¿ç”¨Podmanï¼‰
          if command -v podman &> /dev/null; then
            echo "ğŸ”§ åˆå§‹åŒ–Podmanç¯å¢ƒ..."
            
            # å¯åŠ¨Podman socketæœåŠ¡
            echo "ğŸ”Œ é…ç½®Podman socketæœåŠ¡..."
            sudo systemctl enable --now podman.socket || true
            
            # ç­‰å¾…socketå¯åŠ¨
            sleep 5
            
            # åˆ›å»ºdocker socketé“¾æ¥
            if [ ! -S /var/run/docker.sock ]; then
              sudo ln -sf /run/podman/podman.sock /var/run/docker.sock || true
            fi
            
            # éªŒè¯socketè¿æ¥
            if sudo test -S /run/podman/podman.sock; then
              echo "âœ… Podman socketæœåŠ¡å·²å¯åŠ¨"
            else
              echo "âš ï¸ Podman socketæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ç”¨æˆ·æ¨¡å¼..."
              systemctl --user enable --now podman.socket || true
            fi
            
            # éªŒè¯docker-composeå¯ä»¥é€šè¿‡socketå·¥ä½œ
            echo "ğŸ” éªŒè¯docker-composeä¸Podmançš„å…¼å®¹æ€§..."
            export DOCKER_HOST="unix:///run/podman/podman.sock"
            if docker-compose version; then
              echo "âœ… docker-composeå¯ä»¥é€šè¿‡Podman socketå·¥ä½œ"
            else
              echo "âš ï¸ å°†ä½¿ç”¨ç›´æ¥çš„socketé“¾æ¥æ–¹å¼"
              unset DOCKER_HOST
            fi
          fi
          
          # é…ç½®Dockeré•œåƒæºï¼ˆé¦–æ¬¡éƒ¨ç½²æ—¶ï¼‰
          if [ ! -f /etc/docker/daemon.json ]; then
            echo "ğŸ”§ é…ç½®Dockeré•œåƒæº..."
            mkdir -p /tmp/deploy-package
            cd /tmp
            tar -xzf deploy-config.tar.gz -C deploy-package
            chmod +x /tmp/deploy-package/configure-docker-mirrors.sh
            /tmp/deploy-package/configure-docker-mirrors.sh
          fi
          
          # è§£å‹éƒ¨ç½²åŒ…
          mkdir -p /tmp/deploy-package
          cd /tmp
          tar -xzf deploy-config.tar.gz -C deploy-package
          
          # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ‰§è¡Œéƒ¨ç½²
          export MYSQL_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export MYSQL_ROOT_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export OSS_ACCESS_KEY_ID="${{ secrets.OSS_ACCESS_KEY_ID }}"
          export OSS_ACCESS_KEY_SECRET="${{ secrets.OSS_ACCESS_KEY_SECRET }}"
          export OSS_BUCKET_NAME="${{ secrets.OSS_BUCKET_NAME }}"
          export OSS_ENDPOINT="${{ secrets.OSS_ENDPOINT }}"
          export JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}"
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          /tmp/deploy-package/deploy.sh
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/shop-sphere-image.tar.gz
          rm -f /tmp/deploy-config.tar.gz
          rm -rf /tmp/deploy-package
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼æœåŠ¡çŠ¶æ€ï¼š"
          cd /opt/shop-sphere
          
          # æ£€æµ‹å®¹å™¨è¿è¡Œæ—¶å¹¶æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          if command -v podman &> /dev/null; then
            echo "ğŸ³ ä½¿ç”¨Podmanç¯å¢ƒæ˜¾ç¤ºæœåŠ¡çŠ¶æ€"
            export DOCKER_HOST="unix:///run/podman/podman.sock"
            docker-compose -f docker-compose.prod.yml ps || {
              echo "âš ï¸ é€šè¿‡socketè¿æ¥å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥..."
              unset DOCKER_HOST
              docker-compose -f docker-compose.prod.yml ps
            }
          else
            docker-compose -f docker-compose.prod.yml ps
          fi 