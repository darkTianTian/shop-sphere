name: Deploy to ECS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Basic validation
      run: |
        echo "âœ… Python version check:"
        python --version
        echo "âœ… Requirements installed successfully"
        echo "âœ… Code syntax validation:"
        python -m py_compile app/main.py
        echo "âœ… All validations passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y%m%d_%H%M%S')"
    
    - name: Login to Aliyun Container Registry
      uses: docker/login-action@v3
      with:
        registry: registry.cn-beijing.aliyuncs.com
        username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
        password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
    
    - name: Build and push Docker image
      run: |
        echo "ğŸ³ Building Docker image..."
        docker build -f deploy/docker/Dockerfile.prod -t shop-sphere:latest .
        
        # æ ‡è®°é•œåƒç‰ˆæœ¬
        VERSION="${{ steps.date.outputs.date }}"
        REGISTRY_URL="registry.cn-beijing.aliyuncs.com/xiaoliji/shop"
        
        echo "ğŸ·ï¸ Tagging image with version: $VERSION"
        docker tag shop-sphere:latest $REGISTRY_URL:$VERSION
        docker tag shop-sphere:latest $REGISTRY_URL:latest
        
        echo "â¬†ï¸ Pushing images to Aliyun Registry..."
        docker push $REGISTRY_URL:$VERSION
        docker push $REGISTRY_URL:latest
        
        echo "âœ… Image pushed successfully: $REGISTRY_URL:$VERSION"
        
        # ä¿å­˜ç‰ˆæœ¬å·ä¾›åç»­ä½¿ç”¨
        echo "VERSION=$VERSION" >> $GITHUB_ENV
    
    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        mkdir -p deploy-package
        cp deploy/docker/docker-compose.prod.yml deploy-package/
        cp -r deploy/nginx deploy-package/nginx
        cp -r deploy/supervisor deploy-package/supervisor
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy-package/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ECSæœåŠ¡å™¨..."
        
        PROJECT_DIR="/opt/shop-sphere"
        
        # æ£€æµ‹å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ
        if command -v podman &> /dev/null; then
          echo "ğŸ³ ä½¿ç”¨Podmanç¯å¢ƒ"
          CONTAINER_CMD="podman"
          COMPOSE_CMD="docker-compose"
          
          # é…ç½®Podman socket
          echo "ğŸ”Œ é…ç½®Podman socket..."
          sudo systemctl enable --now podman.socket || true
          sleep 3
          
          export DOCKER_HOST="unix:///run/podman/podman.sock"
          
          if ! docker-compose version &> /dev/null; then
            sudo mkdir -p /var/run
            sudo ln -sf /run/podman/podman.sock /var/run/docker.sock || true
            unset DOCKER_HOST
          fi
        else
          echo "ğŸ³ ä½¿ç”¨Dockerç¯å¢ƒ"
          CONTAINER_CMD="docker"
          COMPOSE_CMD="docker-compose"
        fi
        
        echo "ğŸ“¦ ä½¿ç”¨å®¹å™¨å‘½ä»¤: $CONTAINER_CMD, ç¼–æ’å‘½ä»¤: $COMPOSE_CMD"
        
        # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ˆä½¿ç”¨å†…ç½‘åœ°å€ï¼‰
        echo "ğŸ”‘ ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
        $CONTAINER_CMD login --username=${ALIYUN_REGISTRY_USERNAME} --password=${ALIYUN_REGISTRY_PASSWORD} registry-vpc.cn-beijing.aliyuncs.com
        
        # åœæ­¢å½“å‰æœåŠ¡
        if [ -f $PROJECT_DIR/docker-compose.prod.yml ]; then
          echo "â¸ï¸ åœæ­¢å½“å‰æœåŠ¡..."
          cd $PROJECT_DIR && $COMPOSE_CMD -f docker-compose.prod.yml down || true
        fi
        
        # åˆ›å»ºé¡¹ç›®ç›®å½•
        mkdir -p $PROJECT_DIR
        cd $PROJECT_DIR
        
        # æ‹‰å–æœ€æ–°é•œåƒï¼ˆä½¿ç”¨å†…ç½‘åœ°å€ï¼‰
        echo "â¬‡ï¸ æ‹‰å–æœ€æ–°é•œåƒ..."
        REGISTRY_URL="registry-vpc.cn-beijing.aliyuncs.com/xiaoliji/shop"
        VERSION=${DEPLOY_VERSION:-latest}
        
        echo "ğŸ“¦ æ‹‰å–ç‰ˆæœ¬: $VERSION"
        $CONTAINER_CMD pull $REGISTRY_URL:$VERSION
        $CONTAINER_CMD tag $REGISTRY_URL:$VERSION shop-sphere:latest
        
        # é¢„æ‹‰å–nginxé•œåƒï¼ˆä½¿ç”¨é˜¿é‡Œäº‘ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        echo "ğŸ³ é¢„æ‹‰å–nginxé•œåƒ..."
        if $CONTAINER_CMD pull alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/nginx_optimized; then
          echo "âœ… nginxé•œåƒæ‹‰å–æˆåŠŸ"
        else
          echo "âŒ nginxé•œåƒæ‹‰å–å¤±è´¥"
          exit 1
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp /tmp/deploy-package/docker-compose.prod.yml .
        cp -r /tmp/deploy-package/nginx .
        cp -r /tmp/deploy-package/supervisor .
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p uploads logs/nginx logs/supervisor
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        echo "âš™ï¸ åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
        cat > .env << 'ENVEOF'
        # é˜¿é‡Œäº‘RDSæ•°æ®åº“é…ç½®
        DB_HOST=${DB_HOST}
        DB_PORT=${DB_PORT}
        DB_NAME=${DB_NAME}
        DB_USER=${DB_USER}
        DB_PASSWORD=${DB_PASSWORD}
        
        # Redisé…ç½®ï¼ˆå¦‚æœä½¿ç”¨é˜¿é‡Œäº‘Redisï¼‰
        REDIS_HOST=${REDIS_HOST}
        REDIS_PORT=${REDIS_PORT}
        REDIS_PASSWORD=${REDIS_PASSWORD}
        
        # OSSé…ç½®
        OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
        OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
        OSS_BUCKET_NAME=${OSS_BUCKET_NAME}
        OSS_ENDPOINT=${OSS_ENDPOINT}
        
        # JWTé…ç½®
        JWT_SECRET_KEY=${JWT_SECRET_KEY}
        
        # åº”ç”¨é…ç½®
        ENVIRONMENT=production
        DEBUG=false
        HOST=0.0.0.0
        PORT=8000
        SERVER_ENVIRONMENT=PRODUCTION
        PYTHONPATH=/app
        ENVEOF
        
        # æ›¿æ¢ç¯å¢ƒå˜é‡å ä½ç¬¦
        sed -i "s/\${DB_HOST}/$DB_HOST/g" .env
        sed -i "s/\${DB_PORT}/$DB_PORT/g" .env
        sed -i "s/\${DB_NAME}/$DB_NAME/g" .env
        sed -i "s/\${DB_USER}/$DB_USER/g" .env
        sed -i "s/\${DB_PASSWORD}/$DB_PASSWORD/g" .env
        sed -i "s/\${REDIS_HOST}/$REDIS_HOST/g" .env
        sed -i "s/\${REDIS_PORT}/$REDIS_PORT/g" .env
        sed -i "s/\${REDIS_PASSWORD}/$REDIS_PASSWORD/g" .env
        sed -i "s/\${OSS_ACCESS_KEY_ID}/$OSS_ACCESS_KEY_ID/g" .env
        sed -i "s/\${OSS_ACCESS_KEY_SECRET}/$OSS_ACCESS_KEY_SECRET/g" .env
        sed -i "s/\${OSS_BUCKET_NAME}/$OSS_BUCKET_NAME/g" .env
        sed -i "s/\${OSS_ENDPOINT}/$OSS_ENDPOINT/g" .env
        sed -i "s/\${JWT_SECRET_KEY}/$JWT_SECRET_KEY/g" .env
        
        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        if $COMPOSE_CMD -f docker-compose.prod.yml up -d; then
          echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
        else
          echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼š"
          $COMPOSE_CMD -f docker-compose.prod.yml logs
          exit 1
        fi
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..12}; do
          if $COMPOSE_CMD -f docker-compose.prod.yml exec -T web curl -f http://localhost:8000/health; then
            echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
            break
          else
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/12)"
            sleep 10
          fi
          
          if [ $i -eq 12 ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50
            exit 1
          fi
        done
        
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        $COMPOSE_CMD -f docker-compose.prod.yml ps
        EOF
        
        chmod +x deploy-package/deploy.sh
        
        # æ‰“åŒ…é…ç½®æ–‡ä»¶
        tar -czf deploy-config.tar.gz -C deploy-package .
        echo "âœ… Deployment package created: $(ls -lh deploy-config.tar.gz)"
    
    - name: Transfer deployment package to ECS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "deploy-config.tar.gz"
        target: "/tmp/"
    
    - name: Deploy to ECS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        timeout: 600s
        envs: VERSION,GITHUB_SHA
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ALIYUN_REGISTRY_USERNAME="${{ secrets.ALIYUN_REGISTRY_USERNAME }}"
          export ALIYUN_REGISTRY_PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
          export DEPLOY_VERSION="${{ env.VERSION }}"
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_PORT="${{ secrets.DB_PORT }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export REDIS_HOST="${{ secrets.REDIS_HOST }}"
          export REDIS_PORT="${{ secrets.REDIS_PORT }}"
          export REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
          export OSS_ACCESS_KEY_ID="${{ secrets.OSS_ACCESS_KEY_ID }}"
          export OSS_ACCESS_KEY_SECRET="${{ secrets.OSS_ACCESS_KEY_SECRET }}"
          export OSS_BUCKET_NAME="${{ secrets.OSS_BUCKET_NAME }}"
          export OSS_ENDPOINT="${{ secrets.OSS_ENDPOINT }}"
          export JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}"
          
          # è§£å‹éƒ¨ç½²åŒ…
          mkdir -p /tmp/deploy-package
          cd /tmp
          tar -xzf deploy-config.tar.gz -C deploy-package
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          /tmp/deploy-package/deploy.sh
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/deploy-config.tar.gz
          rm -rf /tmp/deploy-package
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼æœåŠ¡çŠ¶æ€ï¼š"
          cd /opt/shop-sphere
          
          # æ£€æµ‹å®¹å™¨è¿è¡Œæ—¶å¹¶æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          if command -v podman &> /dev/null; then
            echo "ï¿½ï¿½ ä½¿ç”¨Podmanç¯å¢ƒæ˜¾ç¤ºæœåŠ¡çŠ¶æ€"
            export DOCKER_HOST="unix:///run/podman/podman.sock"
            docker-compose -f docker-compose.prod.yml ps || {
              echo "âš ï¸ é€šè¿‡socketè¿æ¥å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥..."
              unset DOCKER_HOST
              docker-compose -f docker-compose.prod.yml ps
            }
          else
            docker-compose -f docker-compose.prod.yml ps
          fi 