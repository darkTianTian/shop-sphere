name: Deploy to ECS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Basic validation
      run: |
        echo "âœ… Python version check:"
        python --version
        echo "âœ… Requirements installed successfully"
        echo "âœ… Code syntax validation:"
        python -m py_compile app/main.py
        echo "âœ… All validations passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        echo "ðŸ³ Building Docker image..."
        docker build -f deploy/docker/Dockerfile.prod -t shop-sphere:latest .
        echo "âœ… Docker image built successfully"
        
        # ä¿å­˜é•œåƒä¸ºtaræ–‡ä»¶
        docker save shop-sphere:latest | gzip > shop-sphere-image.tar.gz
        echo "âœ… Docker image saved: $(ls -lh shop-sphere-image.tar.gz)"
    
    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        # åˆ›å»ºéƒ¨ç½²åŒ…ï¼ŒåŒ…å«çŽ°æœ‰çš„é…ç½®æ–‡ä»¶
        mkdir -p deploy-package
        cp deploy/docker/docker-compose.prod.yml deploy-package/
        cp -r deploy/nginx deploy-package/nginx
        cp -r deploy/supervisor deploy-package/supervisor
        cp deploy/scripts/configure-docker-mirrors.sh deploy-package/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy-package/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ°ECSæœåŠ¡å™¨..."
        
        PROJECT_DIR="/opt/shop-sphere"
        
        # åœæ­¢å½“å‰æœåŠ¡
        if [ -f $PROJECT_DIR/docker-compose.prod.yml ]; then
          echo "â¸ï¸ åœæ­¢å½“å‰æœåŠ¡..."
          cd $PROJECT_DIR && docker-compose -f docker-compose.prod.yml down || true
        fi
        
        # åˆ›å»ºé¡¹ç›®ç›®å½•
        mkdir -p $PROJECT_DIR
        cd $PROJECT_DIR
        
        # å¤‡ä»½æ—§é•œåƒ
        if docker images shop-sphere:latest -q | grep -q .; then
          echo "ðŸ’¾ å¤‡ä»½æ—§é•œåƒ..."
          docker tag shop-sphere:latest shop-sphere:backup-$(date +%Y%m%d_%H%M%S) || true
        fi
        
        # åŠ è½½æ–°é•œåƒ
        echo "ðŸ“¦ åŠ è½½æ–°Dockeré•œåƒ..."
        docker load < /tmp/shop-sphere-image.tar.gz
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp /tmp/deploy-package/docker-compose.prod.yml .
        cp -r /tmp/deploy-package/nginx .
        cp -r /tmp/deploy-package/supervisor .
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p uploads logs/nginx logs/supervisor mysql/conf.d redis
        
        # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
        echo "âš™ï¸ åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶..."
        cat > .env << 'ENVEOF'
        # æ•°æ®åº“é…ç½®
        MYSQL_DATABASE=shopsphere
        MYSQL_USER=shopsphere
        MYSQL_PASSWORD=${MYSQL_PASSWORD}
        MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
        
        # OSSé…ç½®
        OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
        OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
        OSS_BUCKET_NAME=${OSS_BUCKET_NAME}
        OSS_ENDPOINT=${OSS_ENDPOINT}
        
        # JWTé…ç½®
        JWT_SECRET_KEY=${JWT_SECRET_KEY}
        
        # åº”ç”¨é…ç½®
        ENVIRONMENT=production
        DEBUG=false
        HOST=0.0.0.0
        PORT=8000
        SERVER_ENVIRONMENT=PRODUCTION
        PYTHONPATH=/app
        ENVEOF
        
        # æ›¿æ¢çŽ¯å¢ƒå˜é‡å ä½ç¬¦
        sed -i "s/\${MYSQL_PASSWORD}/$MYSQL_PASSWORD/g" .env
        sed -i "s/\${MYSQL_ROOT_PASSWORD}/$MYSQL_ROOT_PASSWORD/g" .env
        sed -i "s/\${OSS_ACCESS_KEY_ID}/$OSS_ACCESS_KEY_ID/g" .env
        sed -i "s/\${OSS_ACCESS_KEY_SECRET}/$OSS_ACCESS_KEY_SECRET/g" .env
        sed -i "s/\${OSS_BUCKET_NAME}/$OSS_BUCKET_NAME/g" .env
        sed -i "s/\${OSS_ENDPOINT}/$OSS_ENDPOINT/g" .env
        sed -i "s/\${JWT_SECRET_KEY}/$JWT_SECRET_KEY/g" .env
        
        # å¯åŠ¨æœåŠ¡
        echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
        docker-compose -f docker-compose.prod.yml up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        echo "ðŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..12}; do
          if docker-compose -f docker-compose.prod.yml exec -T web curl -f http://localhost/health; then
            echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
            break
          else
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/12)"
            sleep 10
          fi
          
          if [ $i -eq 12 ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            docker-compose -f docker-compose.prod.yml logs --tail=50
            exit 1
          fi
        done
        
        echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
        docker-compose -f docker-compose.prod.yml ps
        EOF
        
        chmod +x deploy-package/deploy.sh
        
        # æ‰“åŒ…é…ç½®æ–‡ä»¶
        tar -czf deploy-config.tar.gz -C deploy-package .
        echo "âœ… Deployment package created: $(ls -lh deploy-config.tar.gz)"
    
    - name: Transfer Docker image to ECS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "shop-sphere-image.tar.gz"
        target: "/tmp/"
        timeout: 600s
    
    - name: Transfer deployment package to ECS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "deploy-config.tar.gz"
        target: "/tmp/"
    
    - name: Deploy to ECS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        timeout: 600s
        script: |
          # é…ç½®Dockeré•œåƒæºï¼ˆé¦–æ¬¡éƒ¨ç½²æ—¶ï¼‰
          if [ ! -f /etc/docker/daemon.json ]; then
            echo "ðŸ”§ é…ç½®Dockeré•œåƒæº..."
            mkdir -p /tmp/deploy-package
            cd /tmp
            tar -xzf deploy-config.tar.gz -C deploy-package
            chmod +x /tmp/deploy-package/configure-docker-mirrors.sh
            /tmp/deploy-package/configure-docker-mirrors.sh
          fi
          
          # è§£åŽ‹éƒ¨ç½²åŒ…
          mkdir -p /tmp/deploy-package
          cd /tmp
          tar -xzf deploy-config.tar.gz -C deploy-package
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡å¹¶æ‰§è¡Œéƒ¨ç½²
          export MYSQL_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export MYSQL_ROOT_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export OSS_ACCESS_KEY_ID="${{ secrets.OSS_ACCESS_KEY_ID }}"
          export OSS_ACCESS_KEY_SECRET="${{ secrets.OSS_ACCESS_KEY_SECRET }}"
          export OSS_BUCKET_NAME="${{ secrets.OSS_BUCKET_NAME }}"
          export OSS_ENDPOINT="${{ secrets.OSS_ENDPOINT }}"
          export JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}"
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          /tmp/deploy-package/deploy.sh
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/shop-sphere-image.tar.gz
          rm -f /tmp/deploy-config.tar.gz
          rm -rf /tmp/deploy-package
          
          echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼æœåŠ¡çŠ¶æ€ï¼š"
          cd /opt/shop-sphere && docker-compose -f docker-compose.prod.yml ps 